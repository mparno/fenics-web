#!/usr/bin/env python

import sys
from make_new_doc_page import generate_doc_pages

index_contents = """
.. This file has been automatically generated by the new_release script

.. _documentation:

.. include:: %s

.. toctree::
   :hidden:
   :glob:

   tutorial/index
   doc_*
   all
   demos
"""

def all_contents(all_versions):

    header = "List of all versions of the documentation"
    hashes = "#"*len(header) + "\n"
    header = hashes + header + "\n" + hashes

    all_versions = "\n".join(["* :doc:`doc_%s`" % v[0]
                              for v in all_versions])
    contents = """
.. This file has been automatically generated by the new_release script

%s
""" % (header + all_versions)

    return contents

def main(versions, filename):

    # Get data for all (previous) versions from file
    file = open("%s" % filename, 'r')
    print "Reading version data from %s" % filename
    exec(file)
    file.close()

    # Update data file
    if not (versions in all_versions):
        print "Updating %s" % filename
        all_versions.append(versions)
        file = open("%s" % filename, 'w')
        file.write("# This is a generated data file.\n\n")
        file.write("all_versions = %s" % all_versions)
        file.close()
    else:
        print "Version already registered, not updating data file"

    # Generate doc page for this set of versions
    generate_doc_pages([versions], all_versions)

    # Update index.rst
    print "Updating index.rst"
    file = open("index.rst", 'w')
    file.write(index_contents % ("doc_%s.rst" % versions[0]))
    file.close()

    # Update all.rst
    print "Updating all.rst"
    file = open("all.rst", 'w')
    file.write(all_contents(all_versions))
    file.close()

    # Remember to add file to git
    print "\n" + "*"*80
    print "*** Finished generating .rst for %s." % versions[0]
    print "*** Remember do to 'git add doc_%s.rst'" % versions[0]
    print "*"*80


if __name__ == "__main__":

    versions = (sys.argv[1], sys.argv[2])
    main(versions, "versions.py")

